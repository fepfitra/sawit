name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  publish-bins:
    name: publish-bins
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Sync version with tag
      shell: bash
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF_NAME#v}
        echo "Syncing Cargo.toml to version $VERSION"
        # Portable sed: use -i.bak to satisfy BSD sed (macOS), then remove backup
        sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml && rm Cargo.toml.bak

    - name: Build
      run: cargo build --release --target ${{ matrix.target }}

    - name: Package and Upload
      shell: bash
      run: |
        TARGET_NAME=${{ matrix.target }}
        staging="sawit-${TARGET_NAME}"
        mkdir -p "$staging"
        
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp "target/$TARGET_NAME/release/sawit.exe" "$staging/"
          cp "target/$TARGET_NAME/release/saw.exe" "$staging/"
          # Zip with flat structure (no top-level folder)
          cd "$staging"
          7z a "../$staging.zip" *
        else
          cp "target/$TARGET_NAME/release/sawit" "$staging/"
          cp "target/$TARGET_NAME/release/saw" "$staging/"
          # Zip with flat structure (no top-level folder)
          cd "$staging"
          zip -r "../$staging.zip" *
        fi
        
        # Go back to root
        cd ..
    
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: sawit-${{ matrix.target }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
